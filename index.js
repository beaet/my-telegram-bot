const TelegramBot = require('node-telegram-bot-api');
const express = require('express');
const sqlite3 = require('sqlite3').verbose();
require('dotenv').config();  // Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ÙØ§ÛŒÙ„ Ø¨Ø§Ø´Ù‡

const app = express();

const token = process.env.BOT_TOKEN;            // ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª
const adminId = Number(process.env.ADMIN_ID);   // Ø¢ÛŒØ¯ÛŒ Ø§Ø¯Ù…ÛŒÙ†
const webhookUrl = process.env.WEBHOOK_URL;     // Ø¢Ø¯Ø±Ø³ ÙˆØ¨Ù‡ÙˆÚ©
const port = process.env.PORT || 10000;         // Ù¾ÙˆØ±Øª
// ØªÙ†Ø¸ÛŒÙ… ÙˆØ¨Ù‡ÙˆÚ© Ùˆ Ø±Ø¨Ø§Øª
const bot = new TelegramBot(token, { polling: false });
bot.setWebHook(`${webhookUrl}/bot${token}`);

app.use(express.json());

// Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù¾Ø¯ÛŒØªâ€ŒÙ‡Ø§ Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø² Ø·Ø±ÛŒÙ‚ ÙˆØ¨Ù‡ÙˆÚ©
app.post(`/bot${token}`, (req, res) => {
  bot.processUpdate(req.body);
  res.sendStatus(200);
});

// Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§
const db = new sqlite3.Database('./botdata.sqlite', (err) => {
  if (err) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³:', err.message);
    return;
  }

  // Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ users Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
  db.run(`CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    banned INTEGER DEFAULT 0,
    last_chance_use INTEGER DEFAULT 0,
    username TEXT,
    invites INTEGER DEFAULT 0
  )`, (err) => {
    if (err) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ users:', err.message);
      return;
    }

    // Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ø³ØªÙˆÙ† points
    db.all(`PRAGMA table_info(users)`, (err, columns) => {
      if (err) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÙˆÙ„ users:', err.message);
        return;
      }

      const hasPoints = columns.some(col => col.name === 'points');

      if (!hasPoints) {
        db.run("ALTER TABLE users ADD COLUMN points INTEGER DEFAULT 0", (err) => {
          if (err) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø³ØªÙˆÙ† points:", err.message);
          } else {
            console.log("Ø³ØªÙˆÙ† points Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯");
          }
        });
      } else {
        console.log("Ø³ØªÙˆÙ† points Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯");
      }
    });
  });

  // Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯ Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ settings Ùˆ ØºÛŒØ±Ù‡
});

// ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆÙ‚Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ Ù…Ø®ØªÙ„Ù
const userState = {};

// Ú©Ù…Ú© Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ÛŒØ§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
function ensureUser(user) {
  db.get(`SELECT user_id FROM users WHERE user_id = ?`, [user.id], (err, row) => {
    if (err) {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±:', err);
      return;
    }
    if (!row) {
      db.run(`INSERT INTO users (user_id, username, points) VALUES (?, ?, 5)`, [user.id, user.username || ''], (err) => {
        if (err) console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±Ø¬ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯:', err);
      });
    }
  });
}

// Ú¯Ø±ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
function getUser(userId) {
  return new Promise((resolve, reject) => {
    db.get(`SELECT * FROM users WHERE user_id = ?`, [userId], (err, row) => {
      if (err) reject(err);
      else resolve(row);
    });
  });
}

// Ø¢Ù¾Ø¯ÛŒØª Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø¨Ø± (Ù…Ø«Ø¨Øª ÛŒØ§ Ù…Ù†ÙÛŒ)
function updatePoints(userId, amount) {
  return new Promise((resolve, reject) => {
    db.run(`UPDATE users SET points = points + ? WHERE user_id = ?`, [amount, userId], (err) => {
      if (err) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²:', err);
        reject(err);
      } else {
        resolve();
      }
    });
  });
}

function updateLastChanceUse(userId, timestamp) {
  db.run(`UPDATE users SET last_chance_use = ? WHERE user_id = ?`, [timestamp, userId]);
}

function getLastChanceUse(userId) {
  return new Promise((resolve, reject) => {
    db.get(`SELECT last_chance_use FROM users WHERE user_id = ?`, [userId], (err, row) => {
      if (err) reject(err);
      else resolve(row ? row.last_chance_use : 0);
    });
  });
}

// ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù† Ú©Ø§Ø±Ø¨Ø±
function setBanStatus(userId, status) {
  return new Promise((resolve, reject) => {
    db.run(`UPDATE users SET banned = ? WHERE user_id = ?`, [status ? 1 : 0, userId], (err) => {
      if (err) reject(err);
      else resolve();
    });
  });
}

// Ú¯Ø±ÙØªÙ† Ù…ØªÙ† Ø±Ø§Ù‡Ù†Ù…Ø§
function getHelpText() {
  return new Promise((resolve, reject) => {
    db.get(`SELECT value FROM settings WHERE key = 'help_text'`, (err, row) => {
      if (err) reject(err);
      else resolve(row ? row.value : 'Ù…ØªÙ† Ø±Ø§Ù‡Ù†Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.');
    });
  });
}

// Ø°Ø®ÛŒØ±Ù‡ Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ø±Ø§Ù‡Ù†Ù…Ø§
function setHelpText(newText) {
  db.run(`INSERT OR REPLACE INTO settings (key, value) VALUES ('help_text', ?)`, [newText]);
}

// Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆÙ‚Øª Ú©Ø§Ø±Ø¨Ø±
function resetUserState(userId) {
  delete userState[userId];
}

// Ø§Ø±Ø³Ø§Ù„ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
function sendMainMenu(userId) {
  const keyboard = {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'ğŸ“ŠÙ…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØª', callback_data: 'calculate_rate' },
          { text: 'ğŸ†Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø±Ø¯/Ø¨Ø§Ø®Øª', callback_data: 'calculate_wl' }
        ],
        [
          { text: 'ğŸ”—Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù†', callback_data: 'referral' },
          { text: 'ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„', callback_data: 'profile' }
        ],
        [
          { text: 'ğŸ’¬Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support' }
        ],
        [
          { text: 'ğŸ“šØ±Ø§Ù‡Ù†Ù…Ø§', callback_data: 'help' }
        ],
        [
           { text: 'ğŸØ®Ø±ÛŒØ¯ Ø§Ù…ØªÛŒØ§Ø²', callback_data: 'buy' }
        ],
        [
          { text: 'ğŸ€ Ø´Ø§Ù†Ø³', callback_data: 'chance' }
        ]
      ]
    }
  };

  bot.sendMessage(userId, 'Ø³Ù„Ø§Ù…ØŒ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Mobile Legends Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ âœ¨', keyboard);
}

// Ù‡Ù†Ø¯Ù„ Ø¯Ø³ØªÙˆØ± /start Ø¨Ø§ Ø§Ù…Ú©Ø§Ù† Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª
bot.onText(/\/start(?: (\d+))?/, async (msg, match) => {
  const userId = msg.from.id;
  const refId = match[1] ? parseInt(match[1]) : null;

  ensureUser(msg.from);
  const user = await getUser(userId);
  if (user?.banned) {
    return bot.sendMessage(userId, 'Ø´Ù…Ø§ Ø¨Ù† Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.');
  }

  resetUserState(userId);

  sendMainMenu(userId);
});

// Ù‡Ù†Ø¯Ù„ Ø¯Ø³ØªÙˆØ± /panel ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
bot.onText(/\/panel/, async (msg) => {
  const userId = msg.from.id;
  if (userId !== adminId) {
    return bot.sendMessage(userId, 'Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø¯Ø§Ø±ÛŒØ¯.');
  }

  bot.sendMessage(userId, 'Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª:', {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù…ØªÛŒØ§Ø²', callback_data: 'add_points' },
          { text: 'â– Ú©Ø³Ø± Ø§Ù…ØªÛŒØ§Ø²', callback_data: 'sub_points' }
        ],
        [
          { text: 'ğŸ“¢ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ', callback_data: 'broadcast' }
        ],
        [
          { text: 'ğŸš«Ø¨Ù† Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±', callback_data: 'ban_user' },
          { text: 'â˜‘ï¸Ø­Ø°Ù Ø¨Ù† Ú©Ø§Ø±Ø¨Ø±', callback_data: 'unban_user' }
        ],
        [
          { text: 'ğŸŒØªØºÛŒÛŒØ± Ù…ØªÙ† Ø±Ø§Ù‡Ù†Ù…Ø§', callback_data: 'edit_help' }
        ],
        [
          { text: 'ğŸ¯ Ø¯Ø§Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ù‡Ù…Ù‡', callback_data: 'add_points_all' },
          { text: 'â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª', callback_data: 'panel_back' }
        ]
      ]
    }
  });
});

// Ù‡Ù†Ø¯Ù„ callback query Ù‡Ø§
bot.on('callback_query', async (query) => {
  const userId = query.from.id;
  const data = query.data;

  const user = await getUser(userId);
  if (!user) return await bot.answerCallbackQuery(query.id, { text: 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±.', show_alert: true });

  switch (data) {
    case 'calculate_rate':
    case 'calculate_wl':
      if (user.points <= 0) {
        return bot.answerCallbackQuery(query.id, { text: 'Ø´Ù…Ø§ Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒØ¯.', show_alert: true });
      }
      userState[userId] = {
        type: data === 'calculate_rate' ? 'rate' : 'w/l',
        step: 'total'
      };
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:');

    // Start: Improved "add points to all"
    case 'add_points_all':
      if (userId !== adminId) {
        await bot.answerCallbackQuery(query.id, { text: 'Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.', show_alert: true });
        return;
      }
      userState[userId] = { step: 'add_points_all_enter' };
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'Ú†Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ù‡Ù…Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ØŸ Ù„Ø·ÙØ§ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
    // End: Improved "add points to all"

    case 'referral':
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, `Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø§Ù…ØªÛŒØ§Ø² Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ú¯ÛŒØ±ÛŒØŸ ğŸ
Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø®ÙˆØ¯ØªÙˆ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Øª Ø¨ÙØ±Ø³Øª!
Ù‡Ø± Ú©Ø³ÛŒ Ú©Ù‡ Ø¨Ø§ Ù„ÛŒÙ†Ú© ØªÙˆ ÙˆØ§Ø±Ø¯ Ø±Ø¨Ø§Øª Ø¨Ø´Ù‡ØŒ Ûµ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ø¦Ù…ÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ â­ï¸
Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù…Ø®ØµÙˆØµ Ø´Ù…Ø§â¬‡ï¸:\nhttps://t.me/mlbbratebot?start=${userId}`);

    case 'profile':
      await bot.answerCallbackQuery(query.id);
      const invitesCount = user.invites || 0;
      return bot.sendMessage(userId, `ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ: ${userId}\nâ­ Ø§Ù…ØªÛŒØ§Ø² ÙØ¹Ù„ÛŒ: ${user.points}\nğŸ“¨ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªÛŒâ€ŒÙ‡Ø§: ${invitesCount}`);

    case 'buy':
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'ğŸ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¨Ù‡ Ù¾ÛŒÙˆÛŒ Ø²ÛŒØ± Ù¾ÛŒØ§Ù… Ø¯Ù‡ÛŒØ¯:\n\nğŸ“© @Beast3694');

    case 'chance': {
      await bot.answerCallbackQuery(query.id);
      const dice = Math.floor(Math.random() * 6) + 1;
      let message = `ØªØ§Ø³ Ø´Ù…Ø§: ${dice}\n`;
      const now = Date.now();

      if (dice === 6) {
        await updatePoints(userId, 1);
        message += 'ØªØ¨Ø±ÛŒÚ©! 1 Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.';
      } else {
        message += 'Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø´Ù…Ø§ ØªØ¹Ù„Ù‚ Ù†Ú¯Ø±ÙØª. Ø´Ø§Ù†Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÙØ¹Ù‡ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ú©Ù†ÛŒØ¯.';
      }

      updateLastChanceUse(userId, now);
      await bot.sendMessage(userId, message);
      break;
    }

    case 'support':
      userState[userId] = { step: 'support' };
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'Ø´Ù…Ø§ ÙˆØ§Ø±Ø¯ Ø¨Ø®Ø´ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯!\nÙ¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ù…Ù† ÙÙˆØ±ÙˆØ§Ø±Ø¯ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯ ğŸ“¤\nØ¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒØŒ Ø¯Ø³ØªÙˆØ± /start Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ âª');

    case 'help':
      await bot.answerCallbackQuery(query.id);
      const helpText = await getHelpText();
      return bot.sendMessage(userId, helpText);

    case 'add_points':
    case 'sub_points':
      userState[userId] = { step: 'enter_id', type: data === 'add_points' ? 'add' : 'sub' };
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');

    case 'broadcast':
      if (userId !== adminId) {
        await bot.answerCallbackQuery(query.id, { text: 'Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.', show_alert: true });
        return;
      }
      userState[userId] = { step: 'broadcast' };
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ÛŒØ§ /cancel Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ:');

    case 'ban_user':
      if (userId !== adminId) {
        await bot.answerCallbackQuery(query.id, { text: 'Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.', show_alert: true });
        return;
      }
      userState[userId] = { step: 'ban_enter_id' };
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ù† Ú©Ø±Ø¯Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');

    case 'unban_user':
      if (userId !== adminId) {
        await bot.answerCallbackQuery(query.id, { text: 'Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.', show_alert: true });
        return;
      }
      userState[userId] = { step: 'unban_enter_id' };
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ø¢Ù†â€ŒØ¨Ù† Ú©Ø±Ø¯Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');

    case 'edit_help':
      if (userId !== adminId) {
        await bot.answerCallbackQuery(query.id, { text: 'Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.', show_alert: true });
        return;
      }
      userState[userId] = { step: 'edit_help' };
      await bot.answerCallbackQuery(query.id);
      return bot.sendMessage(userId, 'Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ÛŒØ§ /cancel Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ:');

    default:
      await bot.answerCallbackQuery(query.id);
      break;
  }
});

// Ù‡Ù†Ø¯Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ Ù…Ø®ØªÙ„Ù Ùˆ Ø¹Ù…Ù„ÛŒØ§Øª Ù…ØªÙ†ÛŒ)
bot.on('message', async (msg) => {
  const userId = msg.from.id;
  const text = msg.text || '';

  if (!userState[userId]) return;

  const user = await getUser(userId);
  if (user?.banned) {
    return bot.sendMessage(userId, 'Ø´Ù…Ø§ Ø¨Ù† Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒØ¯.');
  }

  const state = userState[userId];

  if (text === '/cancel') {
    resetUserState(userId);
    return bot.sendMessage(userId, 'Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.', { reply_markup: { remove_keyboard: true } });
  }

  // Ù…Ø±Ø§Ø­Ù„ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª (Ø§Ø¯Ù…ÛŒÙ†)
  if (userId === adminId) {
    switch (state.step) {
      case 'enter_id':
        if (!/^\d+$/.test(text)) return bot.sendMessage(userId, 'Ù„Ø·ÙØ§ ÛŒÚ© Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        state.targetId = parseInt(text);
        if (state.type === 'add') {
          state.step = 'enter_points';
          return bot.sendMessage(userId, 'ØªØ¹Ø¯Ø§Ø¯ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
        } else if (state.type === 'sub') {
          state.step = 'enter_points';
          return bot.sendMessage(userId, 'ØªØ¹Ø¯Ø§Ø¯ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ú©Ø³Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
        }
        break;

      case 'enter_points':
        if (!/^\d+$/.test(text)) return bot.sendMessage(userId, 'Ù„Ø·ÙØ§ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        const pts = parseInt(text);
        if (state.type === 'add') {
          await updatePoints(state.targetId, pts);
          bot.sendMessage(userId, `Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ${state.targetId} Ù…Ù‚Ø¯Ø§Ø± ${pts} Ø§Ù…ØªÛŒØ§Ø² Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`);
        } else if (state.type === 'sub') {
          await updatePoints(state.targetId, -pts);
          bot.sendMessage(userId, `Ø§Ø² Ú©Ø§Ø±Ø¨Ø± ${state.targetId} Ù…Ù‚Ø¯Ø§Ø± ${pts} Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø± Ø´Ø¯.`);
        }
        resetUserState(userId);
        break;

      case 'broadcast':
        resetUserState(userId);
        bot.sendMessage(userId, 'Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...');
        try {
          const rows = await new Promise((res, rej) => {
            db.all(`SELECT user_id FROM users WHERE banned=0`, (err, rows) => err ? rej(err) : res(rows));
          });
          const batchSize = 20;
          for (let i = 0; i < rows.length; i += batchSize) {
            const batch = rows.slice(i, i + batchSize);
            await Promise.all(batch.map(row =>
              bot.sendMessage(row.user_id, `Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ:\n\n${text}`).catch(() => { })
            ));
            await new Promise(res => setTimeout(res, 1000));
          }
        } catch {
          bot.sendMessage(userId, 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ.');
        }
        break;

      case 'ban_enter_id':
        if (!/^\d+$/.test(text)) return bot.sendMessage(userId, 'Ù„Ø·ÙØ§ ÛŒÚ© Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        const banId = parseInt(text);
        await setBanStatus(banId, true);
        resetUserState(userId);
        return bot.sendMessage(userId, `Ú©Ø§Ø±Ø¨Ø± ${banId} Ø¨Ù† Ø´Ø¯.`);

      case 'unban_enter_id':
        if (!/^\d+$/.test(text)) return bot.sendMessage(userId, 'Ù„Ø·ÙØ§ ÛŒÚ© Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        const unbanId = parseInt(text);
        await setBanStatus(unbanId, false);
        resetUserState(userId);
        return bot.sendMessage(userId, `Ú©Ø§Ø±Ø¨Ø± ${unbanId} Ø¢Ù†â€ŒØ¨Ù† Ø´Ø¯.`);

      case 'edit_help':
        await setHelpText(text);
        resetUserState(userId);
        return bot.sendMessage(userId, 'Ù…ØªÙ† Ø±Ø§Ù‡Ù†Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.');

      // Improved "add points to all" logic
      case 'add_points_all_enter': {
        if (!/^\d+$/.test(text)) {
          return bot.sendMessage(userId, 'Ù„Ø·ÙØ§ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ /cancel Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ.');
        }
        const amount = parseInt(text);

        try {
          // 1. Update all users in a single query
          await new Promise((resolve, reject) => {
            db.run(`UPDATE users SET points = points + ? WHERE banned=0`, [amount], err => {
              if (err) reject(err);
              else resolve();
            });
          });

          // 2. Get user IDs to message
          const rows = await new Promise((resolve, reject) => {
            db.all(`SELECT user_id FROM users WHERE banned=0`, (err, rows) => {
              if (err) reject(err);
              else resolve(rows);
            });
          });

          await bot.sendMessage(userId, `Ø§Ù…ØªÛŒØ§Ø² ${amount} Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…...`);

          // 3. Batch notifications (e.g., 20 users per second)
          const batchSize = 20;
          for (let i = 0; i < rows.length; i += batchSize) {
            const batch = rows.slice(i, i + batchSize);
            await Promise.all(batch.map(row =>
              bot.sendMessage(row.user_id, `ğŸ“¢ Ø§Ù…ØªÛŒØ§Ø² ${amount} Ø§Ø² Ø·Ø±Ù Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯.`).catch(() => {})
            ));
            await new Promise(res => setTimeout(res, 1000)); // Wait 1 second between batches
          }

          await bot.sendMessage(userId, `Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.`);

        } catch (err) {
          await bot.sendMessage(userId, 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª.');
        }

        resetUserState(userId);
        return;
      }
    }
  }

  // Ù…Ø±Ø§Ø­Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØª ÛŒØ§ Ø¨Ø±Ø¯/Ø¨Ø§Ø®Øª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ
  if (state.step === 'total') {
    const total = parseInt(text);
    if (isNaN(total) || total <= 0) return bot.sendMessage(userId, 'ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ Ù…Ø«Ø¨Øª ÙˆØ§Ø±Ø¯ Ú©Ù†.');
    state.total = total;
    state.step = 'rate';
    return bot.sendMessage(userId, 'Ø±ÛŒØª ÙØ¹Ù„ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹ 55):');
  }

  if (state.step === 'rate') {
    const rate = parseFloat(text);
    if (isNaN(rate) || rate < 0 || rate > 100) return bot.sendMessage(userId, 'Ø¯Ø±ØµØ¯ Ø±ÛŒØª Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ Ø¨ÛŒÙ† 0 ØªØ§ 100 ÙˆØ§Ø±Ø¯ Ú©Ù†.');

    if (state.type === 'rate') {
      state.rate = rate;
      state.step = 'target';
      return bot.sendMessage(userId, 'Ø±ÛŒØª Ù‡Ø¯Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:');
    } else {
      // Ø­Ø§Ù„Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø±Ø¯/Ø¨Ø§Ø®Øª
      const wins = Math.round((state.total * rate) / 100);
      const losses = state.total - wins;

      await updatePoints(userId, -1); // Ú©Ù… Ú©Ø±Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø²
      resetUserState(userId);

      bot.sendMessage(userId, `Ø¨Ø±Ø¯: ${wins} | Ø¨Ø§Ø®Øª: ${losses}\nØ§Ù…ØªÛŒØ§Ø² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${user.points - 1}`);
      sendMainMenu(userId);
    }
  }

  if (state.step === 'target') {
    const target = parseFloat(text);
    if (isNaN(target) || target < 0 || target > 100) return bot.sendMessage(userId, 'Ø±ÛŒØª Ù‡Ø¯Ù Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ Ø¨ÛŒÙ† 0 ØªØ§ 100 ÙˆØ§Ø±Ø¯ Ú©Ù†.');

    const currentWins = (state.total * state.rate) / 100;
    const neededWins = Math.ceil(((target / 100 * state.total) - currentWins) / (1 - target / 100));

    await updatePoints(userId, -1);
    resetUserState(userId);

    bot.sendMessage(userId, `Ø¨Ø±Ø§ÛŒ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ ${target}% Ø¨Ø§ÛŒØ¯ ${neededWins} Ø¨Ø§Ø²ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ Ø¨Ø¨Ø±ÛŒ.\nØ§Ù…ØªÛŒØ§Ø² Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${user.points - 1}`);
    sendMainMenu(userId);
  }

  // Ù…Ø±Ø­Ù„Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: ÙÙˆØ±ÙˆØ§Ø±Ø¯ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
  if (state.step === 'support') {
    if (msg.message_id) {
      try {
        await bot.forwardMessage(adminId, userId, msg.message_id);
        return bot.sendMessage(userId, 'Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ /start Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
      } catch {
        return bot.sendMessage(userId, 'Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.');
      }
    }
  }
});

app.listen(port, () => {
  console.log(`Server is running on port ${port}`);
});
